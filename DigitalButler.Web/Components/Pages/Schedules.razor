@page "/schedules"
@using DigitalButler.Common
@using DigitalButler.Context
@inject DigitalButler.Data.Repositories.ScheduleRepository Repo
@inject TimeZoneService TimeZones

<PageTitle>Schedules</PageTitle>

<div class="content">
    <h3 class="title is-3">Timezone</h3>
    <p class="subtitle is-6">Summary schedules and date windows use this timezone. Default is UTC.</p>

    @if (!string.IsNullOrWhiteSpace(_tzOverride))
    {
        <div class="notification is-warning is-light">
            Timezone is currently forced by env/config (<strong>Butler:TimeZone</strong>). Admin UI changes won't apply until the override is removed.
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(_tzError))
    {
        <div class="notification is-danger is-light">@_tzError</div>
    }

    @if (!string.IsNullOrWhiteSpace(_tzSaved))
    {
        <div class="notification is-success is-light">@_tzSaved</div>
    }

    <div class="box">
        <EditForm Model="this" OnValidSubmit="SaveTimezoneAsync">
            <div class="field">
                <label class="label">Timezone ID</label>
                <div class="control">
                    <InputText class="input" @bind-Value="_timeZoneId" placeholder="UTC (or e.g. Europe/Prague)" />
                </div>
                <p class="help">On Linux/Docker, use IANA IDs like <code>Europe/Prague</code>, <code>America/New_York</code>, <code>UTC</code>.</p>
            </div>
            <div class="buttons">
                <button class="button is-primary" type="submit">Save Timezone</button>
            </div>
        </EditForm>
    </div>
</div>

<div class="content">
    <h3 class="title is-3">Module Update Schedules</h3>
    <p class="subtitle is-6">Controls how often each source is ingested and how often summaries run.</p>
</div>
@if (_updates is null)
{
    <p>Loading...</p>
}
else
{
    <div class="box">
        <EditForm Model="this" OnValidSubmit="SaveUpdatesAsync">
            <div class="table-container">
                <table class="table is-fullwidth is-striped">
                    <thead>
                        <tr><th>Source</th><th>Cron/Interval</th><th>Enabled</th></tr>
                    </thead>
                    <tbody>
                    @foreach (var item in _updates)
                    {
                        <tr>
                            <td style="white-space:nowrap;">@item.Source</td>
                            <td><InputText @bind-Value="item.CronOrInterval" class="input" /></td>
                            <td>
                                <label class="checkbox">
                                    <InputCheckbox @bind-Value="item.Enabled" />
                                </label>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
            <div class="buttons">
                <button class="button is-primary" type="submit">Save Updates</button>
            </div>
        </EditForm>
    </div>
}

<div class="content">
    <h3 class="title is-3">Summary Schedules</h3>
</div>
@if (_summaries is null)
{
    <p>Loading...</p>
}
else
{
    <div class="box">
        <EditForm Model="this" OnValidSubmit="SaveSummariesAsync">
            <div class="table-container">
                <table class="table is-fullwidth is-striped">
                    <thead>
                        <tr><th>Type</th><th>Day</th><th>Time</th><th>Enabled</th></tr>
                    </thead>
                    <tbody>
                    @foreach (var item in _summaries)
                    {
                        <tr>
                            <td>@(item.IsWeekly ? "Weekly" : "Daily")</td>
                            <td>
                                @if (item.IsWeekly)
                                {
                                    <div class="select">
                                        <InputSelect @bind-Value="item.DayOfWeek">
                                            @foreach (var day in Enum.GetValues<DayOfWeek>())
                                            {
                                                <option value="@day">@day</option>
                                            }
                                        </InputSelect>
                                    </div>
                                }
                            </td>
                            <td>
                                <input type="time" class="input" value="@item.Time.ToString("HH:mm")" 
                                       @onchange="@(e => UpdateTime(item, e.Value?.ToString()))" />
                            </td>
                            <td>
                                <label class="checkbox">
                                    <InputCheckbox @bind-Value="item.Enabled" />
                                </label>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
            <div class="buttons">
                <button class="button is-primary" type="submit">Save Summaries</button>
            </div>
        </EditForm>
    </div>
}

@code {
    private List<ScheduleConfig>? _updates;
    private List<SummarySchedule>? _summaries;
    private string _timeZoneId = "UTC";
    private string? _tzOverride;
    private string? _tzError;
    private string? _tzSaved;

    protected override async Task OnInitializedAsync()
    {
        _tzOverride = TimeZones.GetConfiguredTimeZoneIdOverride();
        _timeZoneId = await TimeZones.GetTimeZoneIdAsync();

        _updates = await Repo.GetAllUpdateSchedulesAsync();
        foreach (var src in Enum.GetValues<ContextSource>())
        {
            if (_updates.All(x => x.Source != src))
            {
                _updates.Add(new ScheduleConfig { Source = src, CronOrInterval = "0 */1 * * *", Enabled = true });
            }
        }

        _summaries = await Repo.GetAllSummarySchedulesAsync();
        if (!_summaries.Any(x => !x.IsWeekly))
        {
            _summaries.Add(new SummarySchedule { IsWeekly = false, Time = new TimeOnly(8, 0), Enabled = true });
        }
        if (!_summaries.Any(x => x.IsWeekly))
        {
            _summaries.Add(new SummarySchedule { IsWeekly = true, DayOfWeek = DayOfWeek.Monday, Time = new TimeOnly(9, 0), Enabled = true });
        }
    }

    private async Task SaveTimezoneAsync()
    {
        _tzError = null;
        _tzSaved = null;

        try
        {
            await TimeZones.SetTimeZoneIdAsync(_timeZoneId);
            _tzSaved = "Saved.";
        }
        catch (TimeZoneNotFoundException)
        {
            _tzError = "Unknown timezone ID for this OS.";
        }
        catch (InvalidTimeZoneException)
        {
            _tzError = "Invalid timezone.";
        }
    }

    private async Task SaveUpdatesAsync()
    {
        if (_updates is null) return;
        await Repo.ReplaceUpdateSchedulesAsync(_updates);
    }

    private async Task SaveSummariesAsync()
    {
        if (_summaries is null) return;
        await Repo.ReplaceSummarySchedulesAsync(_summaries);
    }

    private void UpdateTime(SummarySchedule schedule, string? timeString)
    {
        if (TimeOnly.TryParse(timeString, out var time))
        {
            schedule.Time = time;
        }
    }
}
