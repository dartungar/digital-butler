@page "/skills"
@inject global::DigitalButler.Data.Repositories.SkillInstructionRepository Repo

<PageTitle>Skills</PageTitle>

<div class="content">
    <h3 class="title is-3">Instructions per Skill</h3>
    <p class="subtitle is-6">These are used to guide skill responses (summary/motivation/activities).</p>
</div>

@if (_items is null)
{
    <p>Loading...</p>
}
else
{
    <div class="box">
        <EditForm Model="this" OnValidSubmit="SaveAsync">
            <div class="table-container">
                <table class="table is-fullwidth is-striped">
                    <thead>
                        <tr>
                            <th>Skill</th>
                            <th>Context Sources</th>
                            <th>AI Context</th>
                            <th>Content</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var item in _items)
                    {
                        <tr>
                            <td style="white-space:nowrap;">@item.Skill</td>
                            <td style="min-width:240px;">
                                @foreach (var source in Enum.GetValues<global::DigitalButler.Common.ContextSource>())
                                {
                                    <label class="checkbox" style="display:block;">
                                        <input type="checkbox"
                                               checked="@IsSourceEnabled(item, source)"
                                               @onchange="(e) => SetSourceEnabled(item, source, (bool)(e.Value ?? false))" />
                                        @source
                                    </label>
                                }
                            </td>
                            <td style="white-space:nowrap;">
                                <label class="checkbox">
                                    <InputCheckbox @bind-Value="item.EnableAiContext" />
                                    Enable
                                </label>
                            </td>
                            <td>
                                <InputTextArea class="textarea" style="min-width:400px;" @bind-Value="item.Content" />
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
            <div class="buttons">
                <button class="button is-primary" type="submit">Save</button>
            </div>
        </EditForm>
    </div>
}

@code {
    private List<global::DigitalButler.Common.SkillInstruction>? _items;

    protected override async Task OnInitializedAsync()
    {
        _items = await Repo.GetAllAsync();
        foreach (var skill in Enum.GetValues<global::DigitalButler.Common.ButlerSkill>())
        {
            if (_items.All(x => x.Skill != skill))
            {
                _items.Add(new global::DigitalButler.Common.SkillInstruction { Skill = skill, Content = string.Empty, ContextSourcesMask = -1, EnableAiContext = false });
            }
        }

        // Materialize defaults for legacy rows so the UI shows the effective configuration.
        foreach (var item in _items)
        {
            item.ContextSourcesMask = global::DigitalButler.Common.SkillContextDefaults.ResolveSourcesMask(item.Skill, item.ContextSourcesMask);
        }
    }

    private static bool IsSourceEnabled(global::DigitalButler.Common.SkillInstruction item, global::DigitalButler.Common.ContextSource source)
    {
        var mask = global::DigitalButler.Common.SkillContextDefaults.ResolveSourcesMask(item.Skill, item.ContextSourcesMask);
        return global::DigitalButler.Common.ContextSourceMask.Contains(mask, source);
    }

    private static void SetSourceEnabled(global::DigitalButler.Common.SkillInstruction item, global::DigitalButler.Common.ContextSource source, bool enabled)
    {
        // If the row is still "defaults", expand it before toggling.
        var mask = global::DigitalButler.Common.SkillContextDefaults.ResolveSourcesMask(item.Skill, item.ContextSourcesMask);
        var bit = global::DigitalButler.Common.ContextSourceMask.For(source);
        item.ContextSourcesMask = enabled ? (mask | bit) : (mask & ~bit);
    }

    private async Task SaveAsync()
    {
        if (_items is null) return;
        await Repo.ReplaceAllAsync(_items);
    }
}
