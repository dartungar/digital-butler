@page "/google-calendar"
@using DigitalButler.Common
@inject DigitalButler.Data.Repositories.GoogleCalendarFeedRepository Repo

<PageTitle>Google Calendar</PageTitle>

<div class="content">
    <h3 class="title is-3">Google Calendar iCal Feeds</h3>
    <p class="subtitle is-6">Add one iCal feed per account/calendar. These are stored in the SQLite database.</p>
</div>

@if (_feeds is null)
{
    <p>Loading...</p>
}
else
{
    <div class="box">
        <EditForm Model="this" OnValidSubmit="SaveAsync">
            <div class="table-container">
                <table class="table is-fullwidth is-striped">
                    <thead>
                    <tr>
                        <th>Name</th>
                        <th>iCal URL</th>
                        <th>Enabled</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach (var feed in _feeds)
                    {
                        <tr>
                            <td style="min-width: 220px;">
                                <InputText class="input" @bind-Value="feed.Name" />
                            </td>
                            <td>
                                <InputText class="input" @bind-Value="feed.Url" />
                            </td>
                            <td style="width: 90px;">
                                <label class="checkbox">
                                    <InputCheckbox @bind-Value="feed.Enabled" />
                                </label>
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>

            <div class="buttons">
                <button class="button is-primary" type="submit">Save</button>
                <button class="button" type="button" @onclick="AddRow">Add Feed</button>
            </div>
        </EditForm>
    </div>
}

@code {
    private List<GoogleCalendarFeed>? _feeds;

    protected override async Task OnInitializedAsync()
    {
        _feeds = await Repo.GetAllAsync();
        if (_feeds.Count == 0)
        {
            _feeds.Add(new GoogleCalendarFeed { Name = "Primary", Url = string.Empty, Enabled = true });
        }
    }

    private void AddRow()
    {
        _feeds ??= new List<GoogleCalendarFeed>();
        _feeds.Add(new GoogleCalendarFeed { Name = "New feed", Url = string.Empty, Enabled = true });
    }

    private async Task SaveAsync()
    {
        if (_feeds is null) return;

        await Repo.ReplaceAllAsync(_feeds);

        // Refresh list
        _feeds = await Repo.GetAllAsync();
        if (_feeds.Count == 0)
        {
            _feeds.Add(new GoogleCalendarFeed { Name = "Primary", Url = string.Empty, Enabled = true });
        }
    }
}
