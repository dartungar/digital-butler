@page "/instructions"
@inject DigitalButler.Context.Repositories.InstructionRepository Repo
@using DigitalButler.Context

<PageTitle>Instructions</PageTitle>

<div class="content">
    <h3 class="title is-3">Instructions per Source</h3>
    <p class="subtitle is-6">These are used to guide summarization per context source.</p>
</div>

@if (_items is null)
{
    <p>Loading...</p>
}
else
{
    <div class="box">
        <EditForm Model="this" OnValidSubmit="SaveAsync">
            <div class="table-container">
                <table class="table is-fullwidth is-striped">
                    <thead>
                        <tr>
                            <th>Source</th>
                            <th>Content</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var item in _items)
                    {
                        <tr>
                            <td style="white-space:nowrap;">@item.Source</td>
                            <td>
                                <InputTextArea class="textarea" style="min-width:400px;" @bind-Value="item.Content" />
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
            <div class="buttons">
                <button class="button is-primary" type="submit">Save</button>
            </div>
        </EditForm>
    </div>
}

@code {
    private List<Instruction>? _items;

    protected override async Task OnInitializedAsync()
    {
        _items = await Repo.GetAllAsync();
        foreach (var src in Enum.GetValues<ContextSource>())
        {
            if (_items.All(x => x.Source != src))
            {
                _items.Add(new Instruction { Source = src, Content = string.Empty });
            }
        }
    }

    private async Task SaveAsync()
    {
        if (_items is null) return;

        await Repo.ReplaceAllAsync(_items);
    }
}
